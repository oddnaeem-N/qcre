<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<title>DU Admission Test Paper Generator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Tiro+Bangla&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
body{font-family:'Tiro Bangla',serif;margin:2px;padding:0;font-size:16px;}
#exam-title{font-size:25px;font-weight:bold;text-align:center;margin-bottom:5px;}
.section-header{background:#f8f9fa;font-weight:bold;font-size:18px;padding:6px;margin-top:10px;border:none;}
.question-box{padding:6px;margin:4px 0;border:none;page-break-inside:avoid;}
.options{display:flex;flex-wrap:wrap;gap:10px;margin-top:4px;}
.option{width:48%;}
#toolbar{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:5px;}
.a4-page{width:210mm;min-height:297mm;display:flex;flex-wrap:wrap;page-break-after:always;box-sizing:border-box;padding:2px;}
.column{width:50%;padding:0 2px;box-sizing:border-box;display:flex;flex-direction:column;}
</style>
</head>
<body>

<div id="toolbar">
<button class="btn btn-primary" onclick="setExamTitle()">Set Exam Name</button>
<button class="btn btn-warning" onclick="openAddSectionModal()">Add Section</button>
<button class="btn btn-success" onclick="downloadPDF()">Download PDF</button>
<button class="btn btn-secondary" onclick="exportJSON()">Export JSON</button>
<button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">Import JSON</button>
<input type="file" id="importFile" accept=".json" style="display:none" onchange="importJSON(event)">
<button class="btn btn-danger" onclick="clearExam()">Clear</button>
</div>

<div id="exam-paper">
  <div id="exam-title">DU Admission Test</div>
  <hr>
</div>

<!-- Section Modal -->
<div class="modal" id="sectionModal">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header"><h5 class="modal-title">Add Section</h5><button class="btn-close" onclick="closeSectionModal()"></button></div>
<div class="modal-body">
<form id="sectionForm">
<label>Section Name</label>
<input type="text" id="sectionName" class="form-control mb-2" required>
<label><input type="checkbox" id="newPage"> Start on new page</label>
<h6>Questions</h6>
<div id="questionsContainer"></div>
<button type="button" class="btn btn-sm btn-success mt-2" onclick="addQuestionForm()">Add Question</button>
</form>
</div>
<div class="modal-footer"><button class="btn btn-primary" id="saveSectionBtn">Save</button></div>
</div></div></div>

<script>
let examTitle=localStorage.getItem("examTitle")||"DU Admission Test";
let sections=JSON.parse(localStorage.getItem("sections")||"[]");
document.getElementById("exam-title").innerText=examTitle;

function banglaNumber(n){return n.toString().split('').map(d=>['০','১','২','৩','৪','৫','৬','৭','৮','৯'][parseInt(d)]).join('');}

/* Render Sections with Dynamic Height Flow */
function renderSections(){
  const paper=document.getElementById("exam-paper");
  paper.querySelectorAll(".a4-page").forEach(x=>x.remove());

  const pageHeight=1120; // Approx A4 content height in px
  let page=document.createElement("div"); page.className='a4-page';
  let colL=document.createElement("div"); colL.className="column";
  let colR=document.createElement("div"); colR.className="column";
  page.appendChild(colL); page.appendChild(colR); paper.appendChild(page);
  let leftHeight=0, rightHeight=0;

  sections.forEach(sec=>{
    if(sec.newPage){
        page=document.createElement("div"); page.className='a4-page';
        colL=document.createElement("div"); colL.className="column";
        colR=document.createElement("div"); colR.className="column";
        page.appendChild(colL); page.appendChild(colR); paper.appendChild(page);
        leftHeight=0; rightHeight=0;
    }

    const header=document.createElement("div"); header.className="section-header"; header.innerText=sec.name;

    // Section header first, left column if possible
    if(leftHeight+header.offsetHeight<pageHeight){ colL.appendChild(header); leftHeight+=header.offsetHeight+4; }
    else if(rightHeight+header.offsetHeight<pageHeight){ colR.appendChild(header); rightHeight+=header.offsetHeight+4; }
    else{
        page=document.createElement("div"); page.className='a4-page';
        colL=document.createElement("div"); colL.className="column";
        colR=document.createElement("div"); colR.className="column";
        page.appendChild(colL); page.appendChild(colR); paper.appendChild(page);
        leftHeight=0; rightHeight=0;
        colL.appendChild(header); leftHeight+=header.offsetHeight+4;
    }

    sec.questions.forEach((q,i)=>{
      const qb=document.createElement("div"); qb.className="question-box";
      qb.innerHTML=`<strong>প্রশ্ন ${banglaNumber(i+1)}:</strong> ${q.text}`;
      const opts=document.createElement("div"); opts.className="options";
      ['(ক)','(খ)','(গ)','(ঘ)'].forEach((l,j)=>{const od=document.createElement("div");od.className="option";od.innerText=`${l} ${q.options[j]}`;opts.appendChild(od);});
      qb.appendChild(opts);

      // TEMP append invisible to measure height
      qb.style.visibility="hidden"; document.body.appendChild(qb);
      const qbHeight=qb.offsetHeight+4; // margin
      document.body.removeChild(qb); qb.style.visibility="visible";

      if(leftHeight+qbHeight<=pageHeight){ colL.appendChild(qb); leftHeight+=qbHeight; }
      else if(rightHeight+qbHeight<=pageHeight){ colR.appendChild(qb); rightHeight+=qbHeight; }
      else{
        page=document.createElement("div"); page.className='a4-page';
        colL=document.createElement("div"); colL.className="column";
        colR=document.createElement("div"); colR.className="column";
        page.appendChild(colL); page.appendChild(colR); paper.appendChild(page);
        leftHeight=0; rightHeight=0;
        colL.appendChild(qb); leftHeight+=qbHeight;
      }
    });
  });
}

/* Toolbar functions */
function setExamTitle(){const t=prompt("Enter exam title:",examTitle);if(!t)return;examTitle=t;localStorage.setItem("examTitle",t);document.getElementById("exam-title").innerText=t;}
function clearExam(){if(!confirm("Clear everything?"))return;localStorage.clear();sections=[];examTitle="DU Admission Test";document.getElementById("exam-title").innerText=examTitle;renderSections();}
function openAddSectionModal(){
  document.getElementById("sectionForm").reset(); document.getElementById("questionsContainer").innerHTML=""; addQuestionForm();
  document.getElementById("sectionModal").style.display="block";
  document.getElementById("saveSectionBtn").onclick=function(){
    const name=document.getElementById("sectionName").value.trim();
    const newPage=document.getElementById("newPage").checked;
    const qdivs=document.querySelectorAll(".question-form");const arr=[];
    qdivs.forEach(q=>{arr.push({text:q.querySelector(".q-text").value,options:Array.from(q.querySelectorAll(".option-input")).map(i=>i.value)});});
    sections.push({name,newPage,questions:arr});
    localStorage.setItem("sections",JSON.stringify(sections));
    renderSections();closeSectionModal();
  };
}
function closeSectionModal(){document.getElementById("sectionModal").style.display="none";}
function addQuestionForm(){
  const box=document.createElement("div");box.className="question-form mb-2";
  box.innerHTML=`<input class="form-control q-text mb-1" placeholder="Question" required>
  <div class="d-flex gap-2">
  <input class="form-control option-input" placeholder="ক" required>
  <input class="form-control option-input" placeholder="খ" required>
  <input class="form-control option-input" placeholder="গ" required>
  <input class="form-control option-input" placeholder="ঘ" required>
  </div>`;
  document.getElementById("questionsContainer").appendChild(box);
}

/* PDF Download */
function downloadPDF(){const element=document.getElementById("exam-paper");html2pdf().set({margin:0.1,filename:examTitle+".pdf",image:{type:"jpeg",quality:1},html2canvas:{scale:2},jsPDF:{unit:"mm",format:"a4"}}).from(element).save();}

/* JSON */
function exportJSON(){const data={examTitle,sections};const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="exam.json";a.click();}
function importJSON(e){const file=e.target.files[0];const reader=new FileReader();reader.onload=function(evt){const data=JSON.parse(evt.target.result);examTitle=data.examTitle;sections=data.sections;localStorage.setItem("examTitle",examTitle);localStorage.setItem("sections",JSON.stringify(sections));document.getElementById("exam-title").innerText=examTitle;renderSections();alert("Import successful");};reader.readAsText(file);}

renderSections();
</script>
</body>
</html>
