<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<title>MCQ Exam App</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<style>
body{
    font-family: "SolaimanLipi", sans-serif;
    background:#f8f9fb; margin:0; padding:0;
}
.container{ max-width:600px; margin:auto; padding:20px;}
.card{ background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 8px #0002; margin-bottom:20px;}
h2{margin:0 0 15px; font-weight:600;}
button{padding:10px 18px; background:#007bff; color:#fff; border:none; border-radius:5px; cursor:pointer; font-size:16px;}
button:hover{background:#005fc7;}
canvas{width:100%!important;}
.question{ padding:12px; border:1px solid #ddd; margin-bottom:12px; border-radius:8px; background:#fff;}
.option{border:1px solid #ccc; padding:8px; margin:6px 0; border-radius:5px; cursor:pointer;}
.option.locked{pointer-events:none; opacity:.7;}
.option.correct{background:#d6ffe2; border-color:#4CAF50;}
.option.wrong{background:#ffe2e2; border-color:#ff4d4d;}
.hidden{display:none;}
.backBtn{background:#444!important;}
.topWrong{border-left:4px solid #ff4d4d; padding:8px; margin:8px 0; font-size:16px;}
</style>
</head>
<body>
<div class="container">

<!-- LANDING PAGE -->
<div id="homePage" class="card">
    <h2>üìò MCQ Exam System</h2>
    <input type="file" id="jsonFile" accept=".json">
    <button onclick="startExam()">Start Exam</button>

    <div id="statsArea" class="hidden" style="margin-top:20px;">
        <h3>üìä ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡¶æ‡¶∞‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏</h3>
        <canvas id="pieChart" height="200"></canvas>
        <h3 style="margin-top:20px;">‚ùå ‡¶∏‡¶¨‡¶ö‡ßá‡ßü‡ßá ‡¶¨‡ßá‡¶∂‡¶ø ‡¶≠‡ßÅ‡¶≤ ‡ß´‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®</h3>
        <div id="topWrongList"></div>
    </div>
</div>

<!-- EXAM PAGE -->
<div id="examPage" class="card hidden">
    <h2>üìù Exam Started</h2>
    <div id="questionBox"></div>
    <button onclick="finishExam()" style="margin-top:20px;">Submit</button>
</div>

<!-- RESULT PAGE -->
<div id="resultPage" class="card hidden">
    <h2>üìë Result</h2>
    <div id="resultText"></div>
    <button class="backBtn" onclick="goHome()">Back to Home</button>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let master=[], selected=[], userAns={}, stats={};

function stableHash(str){let h=0,i,chr;if(str.length===0) return "0";for(i=0;i<str.length;i++){chr=str.charCodeAt(i);h=(h<<5)-h+chr;h|=0;}return ("_"+Math.abs(h).toString(36));}

document.getElementById("jsonFile").addEventListener("change", e=>{
    const f=e.target.files[0];
    if(!f) return;
    const r=new FileReader();
    r.onload=ev=>{
        const data=JSON.parse(ev.target.result);
        master=data.questions;
        stats=JSON.parse(localStorage.getItem("stats")||"{}");
        alert("JSON Loaded!");
        showStats();
    }
    r.readAsText(f);
});

/* --- SHOW STATS --- */
function showStats(){
    const statsArea=document.getElementById("statsArea");
    statsArea.classList.remove("hidden");

    let correctCount=0, wrongCount=0;
    master.forEach(q=>{
        const h=stableHash(JSON.stringify({t:q.text,o:q.option,c:q.correct}));
        const s=stats[h]||{wrong:0,right:0};
        correctCount+=s.right; wrongCount+=s.wrong;
    });

    const ctx=document.getElementById("pieChart").getContext("2d");
    if(window.myChart) window.myChart.destroy();
    window.myChart=new Chart(ctx,{
        type:'pie',
        data:{labels:["Correct","Wrong"],datasets:[{data:[correctCount,wrongCount],backgroundColor:["#4CAF50","#ff4d4d"]}]}
    });

    // top 5 wrong
    let arr=[];
    for(let k in stats) arr.push({text:k, wrong:stats[k].wrong});
    arr.sort((a,b)=>b.wrong-a.wrong);
    arr=arr.slice(0,5);

    const hashToText={};
    master.forEach(q=>{const h=stableHash(JSON.stringify({t:q.text,o:q.option,c:q.correct})); hashToText[h]=q.text;});

    const topDiv=document.getElementById("topWrongList");
    topDiv.innerHTML="";
    arr.forEach(it=>{
        const d=document.createElement("div");
        const realQ=hashToText[it.text]||it.text;
        d.className="topWrong";
        d.innerHTML=`${realQ} <br> ‡¶≠‡ßÅ‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá: ${it.wrong} ‡¶¨‡¶æ‡¶∞`;
        topDiv.appendChild(d);
    });
}

/* --- START EXAM --- */
function startExam(){
    if(!master.length){ alert("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá JSON ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®!"); return; }
    document.getElementById("homePage").classList.add("hidden");
    document.getElementById("examPage").classList.remove("hidden");

    // weighted random
    selected=[];
    let pool=[];
    master.forEach(q=>{
        const h=stableHash(JSON.stringify({t:q.text,o:q.option,c:q.correct}));
        const w=(stats[h]&&stats[h].wrong)? stats[h].wrong+1 :1;
        for(let i=0;i<w;i++) pool.push(q);
    });

    // pick 24 unique
    let used=new Set();
    while(selected.length<24 && pool.length){
        const idx=Math.floor(Math.random()*pool.length);
        const q=pool[idx];
        const h=stableHash(JSON.stringify({t:q.text,o:q.option,c:q.correct}));
        if(!used.has(h)){ selected.push(q); used.add(h); }
        pool.splice(idx,1);
    }

    renderExam();
}

/* --- RENDER EXAM --- */
function renderExam(){
    const box=document.getElementById("questionBox");
    box.innerHTML="";
    selected.forEach((q,i)=>{
        const div=document.createElement("div");
        div.className="question";
        div.innerHTML=`<div style="font-weight:600">${i+1}. ${q.text}</div>`;
        const labels=["‡¶ï","‡¶ñ","‡¶ó","‡¶ò"];
        q.option.forEach((opt,j)=>{
            const odiv=document.createElement("div");
            odiv.className="option";
            odiv.innerText=`${labels[j]}) ${opt}`;
            odiv.addEventListener("click",()=>{
                if(odiv.classList.contains("locked")) return;
                userAns[i]=j;
                Array.from(div.getElementsByClassName("option")).forEach(el=>el.classList.add("locked"));
                if(j===["A","B","C","D"].indexOf(q.correct)) odiv.classList.add("correct");
                else odiv.classList.add("wrong");
            });
            div.appendChild(odiv);
        });
        box.appendChild(div);
    });
}

/* --- FINISH EXAM --- */
function finishExam(){
    let correct=0, wrong=0;
    selected.forEach((q,i)=>{
        const h=stableHash(JSON.stringify({t:q.text,o:q.option,c:q.correct}));
        const ua=userAns[i];
        if(ua===["A","B","C","D"].indexOf(q.correct)){
            correct++;
            stats[h]=stats[h]||{wrong:0,right:0};
            stats[h].right++;
        } else {
            wrong++;
            stats[h]=stats[h]||{wrong:0,right:0};
            stats[h].wrong++;
        }
    });
    localStorage.setItem("stats", JSON.stringify(stats));

    document.getElementById("examPage").classList.add("hidden");
    document.getElementById("resultPage").classList.remove("hidden");
    document.getElementById("resultText").innerHTML=`‡¶∏‡¶†‡¶ø‡¶ï: ${correct} / ‡¶≠‡ßÅ‡¶≤: ${wrong}`;
    showStats();
}

/* --- BACK TO HOME --- */
function goHome(){
    document.getElementById("resultPage").classList.add("hidden");
    document.getElementById("homePage").classList.remove("hidden");
    selected=[]; userAns={};
}
</script>
</body>
</html>
